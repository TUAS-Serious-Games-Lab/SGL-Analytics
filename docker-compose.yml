version: '3.4'

networks:
  frontend:
  proxy:
    internal: true
  backend:
    internal: true

volumes:
  db-data:
  game-logs:
  log-collector-log-files:
  user-registration-log-files:

services:
  db:
    image: ${DOCKER_REGISTRY-}sglanalytics/db
    build:
      context: SGL.Analytics.Backend.DB
      dockerfile: Dockerfile
    environment:
      USERREG_PW:
      LOGS_PW:
      POSTGRES_PASSWORD:
    networks:
    - backend
    volumes:
    - "db-data:/var/lib/postgresql/data"

  logs-collector-migrations:
    image: ${DOCKER_REGISTRY-}sglanalytics/logs-collector
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Logs.Collector/Dockerfile
    entrypoint: ["wait-for-it", "-s", "-t", "120", "db:5432", "--", "psql", "-h", "db", "-U", "sgla_logs", "-f", "DbMigrations.sql"]
    environment:
      PGPASSWORD: $LOGS_PW
    depends_on:
    - db
    networks:
    - backend

  users-registration-migrations:
    image: ${DOCKER_REGISTRY-}sglanalytics/users-registration
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Users.Registration/Dockerfile
    entrypoint: ["wait-for-it", "-s", "-t", "120", "db:5432", "--", "psql", "-h", "db", "-U", "sgla_users", "-f", "DbMigrations.sql"]
    environment:
      PGPASSWORD: $USERREG_PW
    depends_on:
    - db
    networks:
    - backend
  
  logs-collector-app:
    image: ${DOCKER_REGISTRY-}sglanalytics/logs-collector
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Logs.Collector/Dockerfile
    environment:
      ConnectionStrings__LogsContext:
    depends_on:
    - db
    - logs-collector-migrations
    networks:
    - proxy
    - backend
    volumes:
    - "game-logs:/var/game-logs"
    - "log-collector-log-files:/var/log/SGL.Analytics.LogCollector"

  users-registration-app:
    image: ${DOCKER_REGISTRY-}sglanalytics/users-registration
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Users.Registration/Dockerfile
    environment:
      ConnectionStrings__UsersContext:
    depends_on:
    - db
    - users-registration-migrations
    networks:
    - proxy
    - backend
    volumes:
    - "user-registration-log-files:/var/log/SGL.Analytics.UserRegistration"

  api-gateway:
    image: ${DOCKER_REGISTRY-}sglanalytics/api-gateway
    build:
      context: SGL.Analytics.Backend.APIGW
      dockerfile: Dockerfile
    depends_on:
    - logs-collector-app
    - users-registration-app
    restart: "on-failure"
    ports:
      - "80:80"
      - "443:443"
    networks:
    - proxy
    - frontend
