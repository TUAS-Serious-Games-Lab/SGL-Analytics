version: '3.4'

services:
  db:
    image: ${DOCKER_REGISTRY-}sglanalytics/db
    build:
      context: SGL.Analytics.Backend.DB
      dockerfile: Dockerfile
    environment:
      USERREG_PW:
      LOGS_PW:
      POSTGRES_PASSWORD:

  logs-collector-migrations:
    image: ${DOCKER_REGISTRY-}sglanalytics/logs-collector
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Logs.Collector/Dockerfile
    entrypoint: ["wait-for-it", "-s", "-t", "120", "db:5432", "--", "psql", "-h", "db", "-U", "sgla_logs", "-f", "DbMigrations.sql"]
    environment:
      PGPASSWORD: $LOGS_PW
    depends_on:
    - db

  users-registration-migrations:
    image: ${DOCKER_REGISTRY-}sglanalytics/users-registration
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Users.Registration/Dockerfile
    entrypoint: ["wait-for-it", "-s", "-t", "120", "db:5432", "--", "psql", "-h", "db", "-U", "sgla_users", "-f", "DbMigrations.sql"]
    environment:
      PGPASSWORD: $USERREG_PW
    depends_on:
    - db
  
  logs-collector-app:
    image: ${DOCKER_REGISTRY-}sglanalytics/logs-collector
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Logs.Collector/Dockerfile
    environment:
      ConnectionStrings__LogsContext:
    depends_on:
    - db
    - logs-collector-migrations

  users-registration-app:
    image: ${DOCKER_REGISTRY-}sglanalytics/users-registration
    build:
      context: .
      dockerfile: SGL.Analytics.Backend.Users.Registration/Dockerfile
    environment:
      ConnectionStrings__UsersContext:
    depends_on:
    - db
    - users-registration-migrations

  api-gateway:
    image: ${DOCKER_REGISTRY-}sglanalytics/api-gateway
    build:
      context: SGL.Analytics.Backend.APIGW
      dockerfile: Dockerfile
    depends_on:
    - logs-collector-app
    - users-registration-app
