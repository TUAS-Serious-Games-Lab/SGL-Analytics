FROM nginx:1-alpine as final

# Users of the image are expected to mount a volume containing the tls certificate and its key to /etc/ssl/my
# Alternatively the endpoint can changed to /use_vs_cert.sh to import a development certificate generated by visual studio
# But even then, a persistent volume should be mounted to /etc/ssl/my to avoid running the conversion everytime the container is replaced.

RUN apk add --no-cache openssl

ADD etc/*.conf /etc/nginx/
ADD etc/api_conf.d/*.conf /etc/nginx/api_conf.d/
ADD etc/backend_conf.d/*.conf /etc/nginx/backend_conf.d/
ADD use_vs_cert.sh health_check.sh /
ADD dhparams.pem /etc/ssl/dhparams.pem
RUN rm /etc/nginx/conf.d/default.conf &&\
	chmod +x /use_vs_cert.sh /health_check.sh
HEALTHCHECK --start-period=30s CMD /health_check.sh
